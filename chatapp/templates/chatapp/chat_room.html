{% extends 'base.html' %}
{% load static %}

{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="h-10 w-10 rounded-full bg-white flex items-center justify-center text-indigo-600 font-bold">
                    {{ other_user.username|first|upper }}
                </div>
                <h2 class="text-xl font-bold text-white">Chat with {{ other_user.username }}</h2>
            </div>
            <a href="{% url 'chatapp:chat_home' %}" class="text-white hover:text-gray-200 transition-colors">
                <i class="fas fa-chevron-left mr-1"></i> Back
            </a>
        </div>

        <!-- Messages Container -->
        <div id="chat-messages" class="h-96 p-4 overflow-y-auto bg-gray-50 space-y-3">
            {% for message in messages %}
                <div class="flex {% if message.sender.username == request.user.username %}justify-end{% else %}justify-start{% endif %}">
                    <div class="{% if message.sender.username == request.user.username %}message-outgoing{% else %}message-incoming{% endif %}">
                        <div class="text-xs opacity-80 mb-1 {% if message.sender == request.user %}text-blue-100{% else %}text-gray-500{% endif %}">
                            {{ message.sender.username }} • {{ message.timestamp|date:"H:i" }}
                        </div>
                        <p class="break-words">{{ message.content }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="border-t border-gray-200 bg-white p-4">
            <div class="flex items-center space-x-2">
                <input type="text" id="message-input" placeholder="Type your message..." 
                    class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                <button id="send-button" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-2 w-12 h-12 flex items-center justify-center transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatBox = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const currentUser = "{{ request.user.username }}";
        const otherUser = "{{ other_user.username }}";

        chatBox.scrollTop = chatBox.scrollHeight;

        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        // Connect to the WebSocket
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + otherUser + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const message = data.message;
            const sender = data.sender_username;
            const timestamp = data.timestamp;

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === currentUser ? 'justify-end' : 'justify-start'}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `max-w-xs md:max-w-md lg:max-w-lg xl:max-w-xl rounded-lg px-4 py-2 ${
                sender === currentUser 
                    ? 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white' 
                    : 'bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 border border-gray-200'
            }`;

            const infoDiv = document.createElement('div');
            infoDiv.className = `text-xs opacity-80 mb-1 ${sender === currentUser ? 'text-blue-100' : 'text-gray-500'}`;
            infoDiv.textContent = `${sender} • ${new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;

            const contentP = document.createElement('p');
            contentP.className = 'break-words';
            contentP.textContent = message;

            bubbleDiv.appendChild(infoDiv);
            bubbleDiv.appendChild(contentP);
            messageDiv.appendChild(bubbleDiv);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            if (sender !== currentUser && document.hidden && Notification.permission === "granted") {
                new Notification(`New message from ${sender}`, {
                    body: message,
                    icon: '{% static "img/notification-icon.png" %}'
                });
            }
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');

            const errorDiv = document.createElement('div');
            errorDiv.className = 'text-center text-red-500 text-sm py-2';
            errorDiv.textContent = 'Connection lost. Trying to reconnect...';
            chatBox.appendChild(errorDiv);

            setTimeout(() => {
                window.location.reload();
            }, 5000);
        };

        sendButton.onclick = sendMessage;
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                chatSocket.send(JSON.stringify({ message }));
                messageInput.value = '';
            }
        }

        messageInput.focus();
    });
</script>
{% endblock %}
